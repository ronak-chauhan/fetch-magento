import jsonimport loggingfrom odoo.http import Controller, request, routefrom odoo  import fields_logger = logging.getLogger(__name__)RESPONSE_STATUS = {'430': "Invalid/Missing Payload",                   "431": "Given Payload Data Missing",                   "432": "Order Not Found",                   "433": "Success",                   "434": "Auth failed",                   "435": "Invalid Request(Exception Generated)",                   "436": "Product Not Found",                   "437": "Delivery Order Not Found",                   "438": "Given Serial Number Wrong",                   "439": "Serial Number Must Have Only 1 Qty."}PICKING_ALLOW_STATE = ("draft", "waiting", "confirmed", "assigned")NOT_ALLOW_TO_ADD_SERIAL_NUMBER = ["draft", "waiting", "confirmed", "done",                              "cancel"]class LogisticIntegration(Controller):    def token_auth(self):        """This method used to check requested user given token and token        will map with user's profile. in case not found or        expired it will return reject the current transaction."""        response = {"status": False, 'msg': "Invalid token"}        if 'Access-Token' not in request.httprequest.headers:            return response        get_token = request.httprequest.headers['Access-Token']        res_obj = request.env['res.users']        res_id = res_obj.sudo().search([            ('token_ids.token', '=', get_token),            ('token_ids.expires', '>=', fields.Datetime.now())])        if res_id.exists():            response.update(status=True, msg="Successfully Verified")        return response    @route("/api/logistic_order", type='json', auth='public', methods=[        'POST'], csrf=False)    def get_logistic_order(self, **post):        """This controller is used to send delivery orders based on        requested order name."""        user_response = {'msg':"", "code":'', "data":[]}        if not post:            if not request.httprequest.data.decode():                user_response['msg'] = RESPONSE_STATUS["430"]                user_response['code'] = "430"                return json.dumps(user_response)            try:                post = json.loads(request.httprequest.data.decode())            except Exception as e:                pass        if not post:            user_response['msg'] = RESPONSE_STATUS["430"]            user_response['code'] = "430"            return json.dumps(user_response)        if not post.get("instance_name", None) or \            not post.get("user", None) \            or not post.get("psw", None) or  \            not post.get("order_name", None):            user_response['msg'] = RESPONSE_STATUS["431"]            user_response['code'] = "431"            return json.dumps(user_response)        so_obj = request.env["sale.order"]        so = so_obj.sudo().search([('origin', '=', post.get("order_name"))],\             order="id desc", limit=1)        if not so:            user_response['msg'] = RESPONSE_STATUS["432"]            user_response['code'] = "432"            return json.dumps(user_response)        try:            picking = so.picking_ids.filtered(lambda pk: pk.state in                                                         PICKING_ALLOW_STATE                                                         and                                                         pk.picking_type_id.code                                                         == "outgoing")            if not picking:                user_response['msg'] = RESPONSE_STATUS["432"]                user_response['code'] = "432"                return json.dumps(user_response)            delivery_data = []            for pick in picking:                parent_id = pick.partner_id.parent_id or pick.partner_id                phone = parent_id.phone or ""                mobile = parent_id.mobile or ""                # street = parent_id.street or ""                # street2 = parent_id.street2 or ""                # city = parent_id.city or ""                # state = parent_id.state_id and parent_id.state_id.name or ""                # country = parent_id.country_id and parent_id.country_id.name or ""                # zip = parent_id.zip or ""                pick_list = {"erp_order":so.name,                             "erp_shipment": pick.name,                             "magento_order": pick.origin,                             "shipment_person_name": pick.partner_id.display_name,                             "shipment_person_phone": pick.partner_id.phone or                                                      phone or "",                             "shipment_person_phone2": pick.partner_id.mobile or                                                       mobile or "",                             "shipment_person_street": pick.partner_id.street or                                                       "",                             "shipment_person_street2": pick.partner_id.street2                                                        or "",                             "shipment_person_city": pick.partner_id.city or "",                             "shipment_person_state": pick.partner_id.state_id                                                      and                                                      pick.partner_id.state_id.name or "",                             "shipment_person_country":                                 pick.partner_id.country_id and                                 pick.partner_id.country_id.name or "",                             "shipment_person_zip": pick.partner_id.zip or ""                             }                lines = []                for ml in pick.move_lines:                    if ml.state not in ('cancel', 'done'):                        lines.append({'product': ml.product_id.display_name                                                 or "",                                      "sku": ml.product_id.default_code or "",                                      "barcode": ml.product_id.barcode or "",                                      "order_qty": ml.product_uom_qty or 0,                                      "entity_id":ml.id})                pick_list["shipment_product_list"] = lines                delivery_data.append(pick_list)            user_response['msg'] = RESPONSE_STATUS["433"]            user_response['code'] = "433"            user_response['data'] = delivery_data        except Exception as e:            user_response['msg'] = RESPONSE_STATUS["435"]            user_response['code'] = "435"        return json.dumps(user_response)    @route("/api/logistic_order_api", type='json', auth='public', methods=[        'POST'], csrf=False)    def delivered_serial_number(self, **post):        "this controller used to picking done along with serial number."        user_response = {'msg': "", "code": '', "data": []}        token_response = self.token_auth()        if not token_response['status']:            user_response['msg'] = token_response['msg']            user_response['code'] = "434"            return json.dumps(user_response)        if not post:            if not request.httprequest.data.decode():                user_response['msg'] = RESPONSE_STATUS["430"]                user_response['code'] = "430"                return json.dumps(user_response)            try:                post = json.loads(request.httprequest.data.decode())            except Exception as e:                _logger.info("Exception generated {}".format(e))        if not post:            user_response['msg'] = RESPONSE_STATUS["430"]            user_response['code'] = "430"            return json.dumps(user_response)        for pst in [post]:            if "tracking_no" not in pst or "sku_list" not in pst:                user_response['msg'] = RESPONSE_STATUS["431"]                user_response['code'] = "431"                return json.dumps(user_response)            for sub_line in pst.get("sku_list", []):                if "sku" not in sub_line or "entity_id" not in sub_line or \                    "qty" not in sub_line or "sr_no" not in sub_line  or \                    "erp_order" not in sub_line:                    user_response['msg'] = RESPONSE_STATUS["431"]                    user_response['code'] = "431"                    return json.dumps(user_response)        so_obj = request.env["sale.order"]        ml = request.env["stock.move.line"]        stock_move_obj = request.env['stock.move']        response_data = []        picking_list = []        for e_name in post.get("sku_list", []):            e_name['msg'] = RESPONSE_STATUS["433"]            e_name['code'] = "433"            try:                entity_id = e_name.get('entity_id')                sku = e_name.get('sku')                sr_no = e_name.get('sr_no')                qty = e_name.get('qty')                erp_order_name = e_name.get("erp_order", "")                product_id = e_name.get("product_id")                so_name = so_obj.sudo().search([('name', '=', erp_order_name)],                                               order="id desc", limit=1)                if not so_name:                    e_name['msg'] = RESPONSE_STATUS["432"]                    e_name['code'] = "432"                    response_data.append(e_name)                    continue                stock_move_id = stock_move_obj.sudo().search([('id', '=',                                                         entity_id)])                if not stock_move_id:                    e_name['msg'] = RESPONSE_STATUS["432"]                    e_name['code'] = "432"                    response_data.append(e_name)                    continue                del_order = so_name.picking_ids.filtered(lambda pk: pk.state in                               PICKING_ALLOW_STATE and pk.picking_type_id.code ==                               "outgoing" and pk.name == stock_move_id.picking_id.name)                if not del_order:                    e_name['msg'] = RESPONSE_STATUS["437"]                    e_name['code'] = "437"                    response_data.append(e_name)                    continue                if stock_move_id.product_id.id == product_id:                    product_id = stock_move_id.product_id                else:                    e_name['msg'] = RESPONSE_STATUS["436"]                    e_name['code'] = "436"                    response_data.append(e_name)                    continue                if product_id.default_code != sku:                    e_name['msg'] = RESPONSE_STATUS["436"]                    e_name['code'] = "436"                    response_data.append(e_name)                    continue                product_track = False                if product_id.tracking in (False, 'none'):                    pass                else:                    product_track = product_id.tracking                    lot = ml.sudo().search(                        [('lot_id.name', '=', sr_no),                         ('move_id', '!=', False),                         ('move_id.group_id','=', so_name.procurement_group_id.id)])                    if not lot:                        e_name['msg'] = RESPONSE_STATUS["438"]                        e_name['code'] = "438"                        response_data.append(e_name )                        continue                is_checking_line = False                if stock_move_id.picking_id.state == 'confirmed':                    stock_move_id.picking_id.action_assign()                    if stock_move_id.picking_id.state == "confirmed":                        e_name['msg'] = RESPONSE_STATUS["436"]                        e_name['code'] = "436"                        continue                    elif stock_move_id.picking_id.state == "assigned":                        if stock_move_id.picking_id.move_line_ids_without_package:                            is_checking_line = True                    else:                        e_name['msg'] = RESPONSE_STATUS["436"]                        e_name['code'] = "436"                        continue                elif stock_move_id.picking_id.state == "assigned":                    if stock_move_id.picking_id.move_line_ids_without_package:                        is_checking_line = True                    else:                        e_name['msg'] = RESPONSE_STATUS["436"]                        e_name['code'] = "436"                        continue                else:                    e_name['msg'] = RESPONSE_STATUS["436"]                    e_name['code'] = "436"                    continue                if is_checking_line:                    is_valide = False                    for line in \                            stock_move_id.picking_id.move_line_ids_without_package:                        if line.product_id.id == product_id.id:                            if (line.product_uom_qty == line.qty_done or                                line.qty_done > line.product_uom_qty):                                continue                            if product_track:                                if product_track == "serial":                                    if line.qty_done == 0:                                        line.qty_done = qty                                        picking_list.append(                                            stock_move_id.picking_id)                                        is_valide = True                                        break                                    else:                                        continue                                else:                                    line.qty_done = qty                                    is_valide = True                                    picking_list.append(                                        stock_move_id.picking_id)                                    break                    if not is_valide:                        e_name['msg'] = RESPONSE_STATUS["436"]                        e_name['code'] = "436"            except Exception as e:                e_name['msg'] = RESPONSE_STATUS["431"]                e_name['code'] = "431"                _logger.info("Exception Generated {}".format(e))            response_data.append(e_name)        for sm in list(set(picking_list)):            lines = sm.sudo().move_line_ids_without_package.filtered(lambda                                                                         lm:                                                             lm.qty_done == 0)            if lines:                sm.sudo()._check_backorder()                sm.sudo().action_generate_backorder_wizard()                sm.sudo().action_done()            else:                sm.sudo().button_validate()        if response_data:            user_response['msg'] = RESPONSE_STATUS["433"]            user_response['code'] = "433"            user_response["data"] = response_data        else:            user_response['msg'] = RESPONSE_STATUS["431"]            user_response['code'] = "431"        return json.dumps(user_response)